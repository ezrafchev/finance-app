name: Check GitHub Pages Configuration

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/deploy.yml'

permissions:
  contents: read
  pages: write

jobs:
  check-pages:
    runs-on: ubuntu-latest
    steps:
      - name: Check if GitHub Pages is Enabled
        uses: actions/github-script@v7
        with:
          script: |
            console.log('üîç Checking GitHub Pages configuration...');

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            let pages;

            try {
              pages = await github.rest.repos.getPages({ owner, repo });
            } catch (error) {
              if (error.status === 404) {
                console.log('‚ÑπÔ∏è GitHub Pages is not enabled. Attempting to enable via API...');
                try {
                  await github.rest.repos.createPagesSite({
                    owner,
                    repo,
                    build_type: 'workflow'
                  });
                  pages = await github.rest.repos.getPages({ owner, repo });
                } catch (createError) {
                  core.setFailed('‚ùå GitHub Pages is NOT enabled for this repository and automatic setup failed: ' + createError.message);
                  console.log('');
                  console.log('üìñ To enable GitHub Pages:');
                  console.log('1. Go to: https://github.com/' + owner + '/' + repo + '/settings/pages');
                  console.log('2. Under "Build and deployment", select Source: GitHub Actions');
                  console.log('3. Save the settings');
                  console.log('');
                  console.log('üìö For detailed instructions in Portuguese, see: GITHUB_PAGES_SETUP.md');
                  console.log('üîó Direct link: https://github.com/' + owner + '/' + repo + '/blob/main/GITHUB_PAGES_SETUP.md');
                  return;
                }
              } else {
                core.setFailed('Error checking GitHub Pages: ' + error.message);
                return;
              }
            }

            console.log('‚úÖ GitHub Pages is enabled!');
            console.log(`üìç Build type: ${pages.data.build_type || pages.data.source?.type}`);
            console.log(`üåê URL: ${pages.data.html_url || pages.data.url}`);

            if (pages.data.build_type === 'workflow' || pages.data.source?.type === 'workflow') {
              console.log('‚úÖ Source is correctly set to GitHub Actions!');
            } else {
              core.setFailed('‚ö†Ô∏è GitHub Pages source is NOT set to GitHub Actions. Please update repository settings.');
              console.log('');
              console.log('üìñ To fix this:');
              console.log('1. Go to: https://github.com/' + owner + '/' + repo + '/settings/pages');
              console.log('2. Under "Build and deployment", select Source: GitHub Actions');
              console.log('3. See GITHUB_PAGES_SETUP.md for detailed instructions (in Portuguese)');
            }
